include:
  - project: 'rv/it/int/rivos-sdk'
    ref: rivos/main
    file: '/packager/gitlab-ci-packaging-helper.yml'

variables:
  INSTALL_DIR: "/rivos/qemu"

# Override upstream version variable from 'prepare-version' included from gitlab-ci-packaging-helper
prepare-version:
  after_script:
    - full_version="$(git describe --always --tags --abbrev=0 --match='v[0-9].*')"
    - git_tag="${full_version:1}"
    - sed -i -e "s@GIT_TAG=.\+@GIT_TAG=${git_tag}@" gitvars.env
    # Debugging helper
    - cat gitvars.env

docker-build:
  image: gitlab.ba.rivosinc.com:5050/rv/it/int/rivos-sdk:${SDK_BASE_TAG}
  stage: build
  script:
    - apt update
    - |
      apt -y -qq install build-essential \
                         git \
                         libaio-dev \
                         libbz2-dev \
                         libcap-dev \
                         libcap-ng-dev \
                         libcurl4-gnutls-dev \
                         libglib2.0-dev \
                         libfdt-dev \
                         liblua5.3-dev \
                         liblzo2-dev \
                         libpixman-1-dev \
                         libssh2-1-dev \
                         ninja-build \
                         zlib1g-dev
    - mkdir -p build
    - cd build
    - |
      ../configure --prefix="${INSTALL_DIR}" \
                   --target-list=riscv32-softmmu,riscv64-softmmu,aarch64-softmmu,riscv32-linux-user,riscv64-linux-user,x86_64-linux-user,aarch64-linux-user \
                   --enable-plugins
    - make -j
    - make plugins
    - make install
    - make -j
    - tar -czf qemu-install.tar.gz "${INSTALL_DIR}"
  artifacts:
    paths:
      - build/qemu-install.tar.gz
    expire_in: 3h
  rules:
    - if: $CI_COMMIT_BRANCH

package-deb:
  extends: .deploy-deb
  dependencies:
    - prepare-version
    - docker-build
  variables:
    PKG_DESCRIPTION: "Open-source machine emulator."
    PKG_LICENSE: "GPL-2.0"
    PKG_UPSTREAM_VERSION: "${GIT_TAG}"
    PKG_DIRECTORIES: "${INSTALL_DIR}"
    PKG_DEPENDS: "libaio1;libbz2-1.0;libcap2;libcap-ng0;libcurl4;libglib2.0-0;libfdt1;liblzo2-2;libpixman-1-0;libssh2-1;zlib1g"
  before_script:
    - rm -rf "${INSTALL_DIR}"
    - tar -C/ -xzf build/qemu-install.tar.gz

# Rebuild the rivos-sdk where we are exporting the artifacts built here.
update-sdk:
  extends: .update-sdk

nix-build:
  stage: build
  image: gitlab.ba.rivosinc.com:5050/rv/sw/int/rivos-nix
  variables:
    INSTALLABLES: '.?submodules=1#qemu'
    NIX_CONFIG: |
      experimental-features = nix-command flakes
      extra-substituters = https://ps-111.ba.rivosinc.com:9021/nix-cache
      extra-trusted-public-keys = ps-111.ba.rivosinc.com-1:mo+u7qMQnX3nSJg7pPVXVZvBUUhI44rdxdqmGbIsgeQ=
      max-jobs = 8
      cores = 32
  before_script:
    - git config --global url."${CI_SERVER_PROTOCOL}://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}:${CI_SERVER_PORT}".insteadOf "ssh://git@${CI_SERVER_HOST}"
  script:
    - nix build --no-update-lock-file --print-build-logs ${INSTALLABLES}
    - push-rivos-cache ${INSTALLABLES}
  after_script:
    - git config --global --unset url."${CI_SERVER_PROTOCOL}://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}:${CI_SERVER_PORT}".insteadOf

